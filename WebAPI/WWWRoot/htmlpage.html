<!DOCTYPE html>
<html>
<head>
    <title>Simple Calculator</title>
</head>
<body>
    <table>
        <tr>
            <td colspan="4"><input type="text" readonly id="display"></td>
        </tr>
        <tr>
            <td><input type="button" value="1" onclick="Capture('1')" /></td>
            <td><input type="button" value="2" onclick="Capture('2')" /></td>
            <td><input type="button" value="3" onclick="Capture('3')" /></td>
            <td><input type="button" value="C" onclick="Clear()" /></td>
        </tr>
        <tr>
            <td><input type="button" value="4" onclick="Capture('4')" /></td>
            <td><input type="button" value="5" onclick="Capture('5')" /></td>
            <td><input type="button" value="6" onclick="Capture('6')" /></td>
            <td />
        </tr>
        <tr>
            <td><input type="button" value="7" onclick="Capture('7')" /></td>
            <td><input type="button" value="8" onclick="Capture('8')" /></td>
            <td><input type="button" value="9" onclick="Capture('9')" /></td>
            <td><input type="button" value="-" onclick="Capture('-')" /></td>
        </tr>
        <tr>
            <td><input type="button" value="0" onclick="Capture('0')" /></td>
            <td />
            <td><input type="button" value="=" onclick="Capture('=')"> </td>
            <td><input type="button" value="+" onclick="Capture('+')" /></td>
        </tr>
    </table>
    <script>
        var display = document.getElementById("display");

        var start = ""
        var operator = "";
        var amount = "";
        Clear();

        async function RefreshDisplay() {
            display.value = start + operator + amount;
            console.log(`Start=${start}, Operator=${operator}, Amount=${amount}`);
        }

        function Clear() {
            SetStart("0");
            RefreshDisplay();
        }

        async function SetStart(value) {
            start = value;
            operator = "";
            amount = "";
        }

        async function Capture(key) {

            // Remove leading zero
            if (start == "0") {
                start = "";
            }

            // If user pressed equals then calculate
            if (key == "=") {

                // Only calculate if everything available
                if (operator != "" && start != "" && amount != "") {
                    SetStart(await Calculate());
                }
            }

            // Did user pressed plus or minus?
            else if (key == "+" || key == "-") {

                // If start not set then move amount into start
                if (start == "" && amount != "") {
                    start = amount;
                    amount = "";
                }

                // This must be the operator if start set
                if (start != "" && operator == "") {
                    operator = key;
                }

                // If everything set then calculate
                if (operator != "" && start != "" && amount != "") {
                    SetStart(await Calculate());
                    operator = key;
                }

                // Otherwise is this a sign?
                else if (amount == "" && operator != key) {
                    amount += key;
                }
            }

            // Otherwise, concatenate  to amount
            else {
                amount += key;
            }

            RefreshDisplay();
        }

        async function Calculate() {
            var method = operator == "-" ? "subtract" : "add";
            return await fetch(("https://localhost:7159/api/simplecalculator/" + method), {
                method: 'POST',
                headers: {
                    'Accept': 'text/plain',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'start': start, 'amount': amount })
            })
            .then(response => response.text())
            .then(response => JSON.parse(response))
            .then(response => {
                return response['result'];
            });
        };
    </script>
</body>
</html>
